<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é’‰é’‰æœºå™¨äººæµ‹è¯•</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 50%, #0a0a0f 100%);
            min-height: 100vh;
            font-family: 'Inter', sans-serif;
            color: #fff;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .card {
            background: rgba(20, 20, 35, 0.9);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 25px;
            margin-bottom: 20px;
        }
        .title {
            text-align: center;
            margin-bottom: 30px;
        }
        .title h1 {
            font-size: 32px;
            font-weight: 700;
            background: linear-gradient(135deg, #00BFFF, #1E90FF);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .input-group {
            margin-bottom: 15px;
        }
        .input-group label {
            display: block;
            font-size: 12px;
            color: #888;
            margin-bottom: 5px;
        }
        .input-group input, .input-group textarea {
            width: 100%;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: #fff;
            font-size: 14px;
        }
        .input-group textarea {
            height: 80px;
            resize: none;
        }
        .btn {
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            transition: all 0.2s;
        }
        .btn:hover { transform: scale(1.05); }
        .btn:active { transform: scale(0.98); }
        .btn-primary {
            background: linear-gradient(135deg, #00BFFF, #1E90FF);
            border: none;
            color: #fff;
        }
        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            border: none;
        }
        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            border: none;
        }
        .logs {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
        }
        .log-item {
            padding: 5px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        .log-item.send { color: #00BFFF; }
        .log-item.receive { color: #10b981; }
        .log-item.error { color: #ef4444; }
        .log-item.info { color: #888; }
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 20px;
            font-size: 12px;
        }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #6b7280;
        }
        .status-dot.online { background: #10b981; box-shadow: 0 0 10px #10b981; }
        .status-dot.offline { background: #ef4444; }
    </style>
</head>
<body>
    <div class="container">
        <div class="title">
            <h1>ğŸ¤– é’‰é’‰æœºå™¨äººæµ‹è¯•</h1>
            <p style="color: #666; font-size: 12px; margin-top: 5px;">
                DingTalk Robot SDK Demo
            </p>
        </div>

        <!-- é…ç½® -->
        <div class="card">
            <h2 style="font-size: 16px; margin-bottom: 15px; color: #00BFFF;">âš™ï¸ é…ç½®</h2>
            
            <div class="input-group">
                <label>Webhook URL</label>
                <input type="text" id="webhook" placeholder="https://oapi.dingtalk.com/robot/send?access_token=xxx">
            </div>
            
            <div class="input-group">
                <label>å®‰å…¨å…³é”®è¯ (å¯é€‰)</label>
                <input type="text" id="keyword" placeholder="å°T">
            </div>
            
            <div class="input-group">
                <label>åŠ ç­¾å¯†é’¥ Secret (å¯é€‰)</label>
                <input type="text" id="secret" placeholder="SECxxx">
            </div>
            
            <div class="status-badge">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">æœªåˆå§‹åŒ–</span>
            </div>
        </div>

        <!-- å‘é€æ¶ˆæ¯ -->
        <div class="card">
            <h2 style="font-size: 16px; margin-bottom: 15px; color: #10b981;">ğŸ“¤ å‘é€æ¶ˆæ¯</h2>
            
            <div class="input-group">
                <label>æ¶ˆæ¯ç±»å‹</label>
                <select id="msgType" class="btn" style="width: 100%;">
                    <option value="text">æ–‡æœ¬</option>
                    <option value="markdown">Markdown</option>
                    <option value="link">é“¾æ¥å¡ç‰‡</option>
                </select>
            </div>
            
            <div class="input-group">
                <label>æ¶ˆæ¯å†…å®¹</label>
                <textarea id="msgContent" placeholder="è¾“å…¥æ¶ˆæ¯å†…å®¹...">ä½ å¥½ï¼Œæˆ‘æ˜¯å°Tï¼</textarea>
            </div>
            
            <div class="btn-row" style="display: flex; gap: 10px;">
                <button class="btn btn-primary" onclick="sendMessage()">å‘é€æ¶ˆæ¯</button>
                <button class="btn btn-success" onclick="testHealth()">å¥åº·æ£€æŸ¥</button>
            </div>
        </div>

        <!-- æ¶ˆæ¯æ—¥å¿— -->
        <div class="card">
            <h2 style="font-size: 16px; margin-bottom: 15px; color: #FF69B4;">ğŸ“‹ æ¶ˆæ¯æ—¥å¿—</h2>
            <div class="logs" id="logs">
                <div class="log-item info">ğŸ’¡ å¡«å†™é…ç½®åç‚¹å‡»"åˆå§‹åŒ–"å¼€å§‹æµ‹è¯•</div>
            </div>
        </div>

        <!-- å¸®åŠ© -->
        <div class="card">
            <h2 style="font-size: 16px; margin-bottom: 15px; color: #888;">ğŸ“– ä½¿ç”¨è¯´æ˜</h2>
            <div style="font-size: 12px; color: #666; line-height: 1.8;">
                <p>1. åœ¨é’‰é’‰ç¾¤ä¸­æ·»åŠ è‡ªå®šä¹‰æœºå™¨äººï¼Œè·å– Webhook URL</p>
                <p>2. è®¾ç½®å®‰å…¨éªŒè¯ï¼ˆå…³é”®è¯æˆ–åŠ ç­¾ï¼‰</p>
                <p>3. å¡«å†™ä¸Šæ–¹é…ç½®ï¼Œç‚¹å‡»"åˆå§‹åŒ–"</p>
                <p>4. æµ‹è¯•å‘é€æ¶ˆæ¯</p>
                <p>5. æ¥æ”¶å›è°ƒéœ€è¦éƒ¨ç½²åˆ°å…¬ç½‘æˆ–å†…ç½‘ç©¿é€</p>
            </div>
        </div>
    </div>

    <script src="js/dingding.js"></script>
    <script>
        let robot = null;
        const logs = document.getElementById('logs');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');

        function addLog(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `log-item ${type}`;
            const time = new Date().toLocaleTimeString();
            div.textContent = `[${time}] ${message}`;
            logs.appendChild(div);
            logs.scrollTop = logs.scrollHeight;
        }

        function initRobot() {
            const webhook = document.getElementById('webhook').value.trim();
            const keyword = document.getElementById('keyword').value.trim();
            const secret = document.getElementById('secret').value.trim();

            if (!webhook) {
                addLog('âŒ è¯·å¡«å†™ Webhook URL', 'error');
                return;
            }

            try {
                robot = new DingTalkRobot({
                    webhook: webhook,
                    keyword: keyword || undefined,
                    secret: secret || undefined,
                    autoReply: false,
                    llmEndpoint: ''
                });

                robot.init();

                statusDot.className = 'status-dot online';
                statusText.textContent = 'å·²åˆå§‹åŒ–';
                addLog('âœ… æœºå™¨äººåˆå§‹åŒ–æˆåŠŸ', 'success');

            } catch (e) {
                addLog(`âŒ åˆå§‹åŒ–å¤±è´¥: ${e.message}`, 'error');
            }
        }

        async function sendMessage() {
            if (!robot) {
                initRobot();
                if (!robot) return;
            }

            const type = document.getElementById('msgType').value;
            const content = document.getElementById('msgContent').value.trim();

            if (!content) {
                addLog('âŒ è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹', 'error');
                return;
            }

            addLog(`ğŸ“¤ å‘é€ ${type}: ${content.substring(0, 50)}...`, 'send');

            try {
                await robot.send(content, type);
                addLog('âœ… æ¶ˆæ¯å‘é€æˆåŠŸ', 'success');
            } catch (e) {
                addLog(`âŒ å‘é€å¤±è´¥: ${e.message}`, 'error');
            }
        }

        async function testHealth() {
            const webhook = document.getElementById('webhook').value.trim();
            if (!webhook) {
                addLog('âŒ è¯·å…ˆå¡«å†™ Webhook URL', 'error');
                return;
            }

            // æå– token
            const match = webhook.match(/access_token=([^&]+)/);
            if (!match) {
                addLog('âŒ æ— æ³•ä» URL æå– access_token', 'error');
                return;
            }

            const token = match[1];
            addLog('ğŸ” æµ‹è¯• Webhook å¯ç”¨æ€§...', 'info');

            try {
                const response = await fetch(`${webhook}&msgtype=text`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        msgtype: 'text',
                        text: { content: 'ğŸ”§ å¥åº·æ£€æŸ¥æµ‹è¯•' }
                    })
                });

                const data = await response.json();
                
                if (data.errcode === 0) {
                    addLog('âœ… Webhook å¯æ­£å¸¸è®¿é—®', 'success');
                } else {
                    addLog(`âš ï¸ é’‰é’‰è¿”å›é”™è¯¯: ${data.errmsg}`, 'error');
                }
            } catch (e) {
                addLog(`âŒ è¿æ¥å¤±è´¥: ${e.message}`, 'error');
            }
        }

        // åˆå§‹åŒ–æŒ‰é’®äº‹ä»¶
        document.getElementById('webhook').addEventListener('blur', initRobot);
        document.getElementById('keyword').addEventListener('blur', initRobot);
        document.getElementById('secret').addEventListener('blur', initRobot);
    </script>
</body>
</html>
